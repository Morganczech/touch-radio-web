---
import stationsRaw from "../data/stations.normalized.json";
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/Hero.astro";
import Filters from "../components/Filters.astro";
import StationGrid from "../components/StationGrid.astro";
import SelectionSidebar from "../components/SelectionSidebar.astro";
import "../styles/station-item.css";

// Filter valid stations first
const allStations = stationsRaw.filter((s: any) => !s.broken);
// No SSR station rendering - strictly client side

// Extract unique values for filters
const uniqueCountries = [
	...new Set(allStations.map((s: any) => s.country).filter(Boolean)),
].sort();
const uniqueGenres = [
	...new Set(allStations.flatMap((s: any) => s.tags || []).filter(Boolean)),
].sort();
const uniqueCodecs = [
	...new Set(allStations.map((s: any) => s.codec).filter(Boolean)),
].sort();
---

<BaseLayout>
	<main>
		<Hero />
		<Filters
			uniqueCountries={uniqueCountries}
			uniqueGenres={uniqueGenres}
			uniqueCodecs={uniqueCodecs}
		/>
		<section class="content-section">
			<div class="section-header">
				<h2>Available Stations</h2>
				<p class="section-subtitle">
					Select stations and export a playlist
				</p>
			</div>
		</section>
		<div class="content-wrapper">
			<div class="main-content">
				<StationGrid />
			</div>
			<SelectionSidebar />
		</div>
	</main>
</BaseLayout>

<style>
	/* Section Headers */
	.section-header {
		margin-bottom: 1.5rem;
	}

	.section-header h2 {
		font-size: 1.5rem;
		margin-bottom: 0.25rem;
	}

	.section-subtitle {
		color: var(--muted);
		font-size: 0.95rem;
	}

	/* Original Layout */
	.content-wrapper {
		display: flex;
		gap: 2rem;
		align-items: flex-start;
	}

	.main-content {
		flex: 1;
		min-width: 0; /* Prevents overflow in flex items */
	}

	@media (max-width: 1024px) {
		.content-wrapper {
			flex-direction: column;
		}
	}
</style>
<script>
	import stationsRaw from "../data/stations.normalized.json";
	import { appState } from "../scripts/state/appState";
	import { initStations } from "../scripts/stations/stationFilter";
	import {
		initSelection,
		updateUI,
	} from "../scripts/selection/selectionManager";
	import { initDiscoveryBadges } from "../scripts/search/discoveryBadges";
	import { initSearchPlaceholder } from "../scripts/search/searchPlaceholder";

	// Initialize State Source of Truth
	appState.allStations = stationsRaw.filter((s: any) => !s.broken);

	document.addEventListener("DOMContentLoaded", () => {
		initStations();
		initSelection();
		initDiscoveryBadges();
		initSearchPlaceholder();
		updateUI();
	});
</script>
