---
import stations from "../data/stations.normalized.json";
import BaseLayout from "../layouts/BaseLayout.astro";
import StationList from "../components/StationList.astro";
---

<BaseLayout>
	<header>
		<h1>Touch Radio</h1>
	</header>
	<main data-stations={JSON.stringify(stations)}>
		<section>
			<h2>Available Stations</h2>
			<button id="export-btn">Export selected (JSON)</button>
			<StationList stations={stations} />
		</section>
	</main>
	<script>
		// Client-side state management for station selection
		document.addEventListener("DOMContentLoaded", () => {
			const selectedIds = new Set();
			const exportBtn = document.getElementById("export-btn");
			const mainElement = document.querySelector("main");
			// Parse stations data from data attribute safely
			const allStations =
				mainElement && mainElement.dataset.stations
					? JSON.parse(mainElement.dataset.stations)
					: [];

			const checkboxes = document.querySelectorAll(
				'input[type="checkbox"][data-id]',
			);

			checkboxes.forEach((checkbox) => {
				checkbox.addEventListener("change", (event) => {
					const target = event.target as HTMLInputElement;
					const id = target.dataset.id;

					if (id) {
						if (target.checked) {
							selectedIds.add(id);
						} else {
							selectedIds.delete(id);
						}
					}
				});
			});

			if (exportBtn) {
				exportBtn.addEventListener("click", () => {
					if (selectedIds.size === 0) {
						alert("No stations selected.");
						return;
					}

					const selectedStations = allStations.filter(
						(station: any) => selectedIds.has(station.id),
					);
					const jsonString = JSON.stringify(
						selectedStations,
						null,
						2,
					);
					const blob = new Blob([jsonString], {
						type: "application/json",
					});
					const url = URL.createObjectURL(blob);

					const a = document.createElement("a");
					a.href = url;
					a.download = "selected_stations.json";
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				});
			}
		});
	</script>
</BaseLayout>
