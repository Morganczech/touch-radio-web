---
import stations from "../data/stations.normalized.json";
import BaseLayout from "../layouts/BaseLayout.astro";
import StationList from "../components/StationList.astro";

const uniqueCountries = [
	...new Set(stations.map((s) => s.country).filter(Boolean)),
].sort();

const uniqueCodecs = [
	...new Set(stations.map((s) => s.codec).filter(Boolean)),
].sort();
---

<BaseLayout>
	<header>
		<h1>Touch Radio</h1>
	</header>
	<main data-stations={JSON.stringify(stations)}>
		<section>
			<h2>Available Stations</h2>
			<label style="display: block; margin-bottom: 1rem;">
				Search stations:
				<input
					type="search"
					id="search-input"
					placeholder="Type station nameâ€¦"
					autocomplete="off"
					style="margin-left: 0.5rem; padding: 0.25rem;"
				/>
			</label>
			<div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
				<label style="flex: 1;">
					Filter by country:
					<select
						id="country-filter"
						style="width: 100%; margin-top: 0.25rem; padding: 0.25rem;"
					>
						<option value="">All Countries</option>
						{
							uniqueCountries.map((country) => (
								<option value={country}>{country}</option>
							))
						}
					</select>
				</label>
				<label style="flex: 1;">
					Filter by codec:
					<select
						id="codec-filter"
						style="width: 100%; margin-top: 0.25rem; padding: 0.25rem;"
					>
						<option value="">All Codecs</option>
						{
							uniqueCodecs.map((codec) => (
								<option value={codec}>{codec}</option>
							))
						}
					</select>
				</label>
				<label style="flex: 1;">
					Min bitrate (kbps):
					<input
						type="number"
						id="bitrate-filter"
						placeholder="Min kbps"
						style="width: 100%; margin-top: 0.25rem; padding: 0.25rem;"
					/>
				</label>
				<div
					style="flex: 0 0 auto; display: flex; align-items: flex-end;"
				>
					<button id="clear-filters-btn" style="margin-bottom: 0;"
						>Clear filters</button
					>
				</div>
			</div>
			<p>Select stations and export a playlist</p>
			<p>Selected: <span id="selection-count">0</span></p>
			<button id="export-btn" disabled>Export selected (JSON)</button>
			<button id="export-m3u-btn" disabled>Export selected (M3U)</button>
			<button id="export-m3u8-btn" disabled>Export selected (M3U8)</button
			>
			<button id="export-pls-btn" disabled>Export selected (PLS)</button>
			<StationList stations={stations} />
		</section>
	</main>
	<script>
		// Client-side state management for station selection
		document.addEventListener("DOMContentLoaded", () => {
			const selectedIds = new Set();
			const exportBtn = document.getElementById("export-btn");
			const mainElement = document.querySelector("main");
			// Parse stations data from data attribute safely
			const allStations =
				mainElement && mainElement.dataset.stations
					? JSON.parse(mainElement.dataset.stations)
					: [];

			const checkboxes = document.querySelectorAll(
				'input[type="checkbox"][data-id]',
			);

			checkboxes.forEach((checkbox) => {
				checkbox.addEventListener("change", (event) => {
					const target = event.target as HTMLInputElement;
					const id = target.dataset.id;

					if (id) {
						if (target.checked) {
							selectedIds.add(id);
						} else {
							selectedIds.delete(id);
						}
						updateUI();
					}
				});
			});

			// Initial UI update
			const countSpan = document.getElementById("selection-count");
			const buttons = [
				document.getElementById("export-btn"),
				document.getElementById("export-m3u-btn"),
				document.getElementById("export-m3u8-btn"),
				document.getElementById("export-pls-btn"),
			];

			function updateUI() {
				const count = selectedIds.size;
				if (countSpan) {
					countSpan.textContent = count.toString();
				}

				const isDisabled = count === 0;
				buttons.forEach((btn) => {
					if (btn) {
						if (isDisabled) {
							btn.setAttribute("disabled", "true");
						} else {
							btn.removeAttribute("disabled");
						}
					}
				});
			}

			if (exportBtn) {
				exportBtn.addEventListener("click", () => {
					if (selectedIds.size === 0) {
						alert("No stations selected.");
						return;
					}

					const selectedStations = allStations.filter(
						(station: any) => selectedIds.has(station.id),
					);
					const jsonString = JSON.stringify(
						selectedStations,
						null,
						2,
					);
					downloadFile(
						jsonString,
						"selected_stations.json",
						"application/json",
					);
				});
			}

			const exportM3uBtn = document.getElementById("export-m3u-btn");
			if (exportM3uBtn) {
				exportM3uBtn.addEventListener("click", () => {
					if (selectedIds.size === 0) {
						alert("No stations selected.");
						return;
					}

					const selectedStations = allStations.filter(
						(station: any) => selectedIds.has(station.id),
					);

					let m3uContent = "#EXTM3U\n";
					selectedStations.forEach((station: any) => {
						m3uContent += `#EXTINF:-1,${station.name}\n${station.streamUrl}\n`;
					});

					downloadFile(
						m3uContent,
						"selected_stations.m3u",
						"text/plain",
					);
				});
			}

			const exportM3u8Btn = document.getElementById("export-m3u8-btn");
			if (exportM3u8Btn) {
				exportM3u8Btn.addEventListener("click", () => {
					if (selectedIds.size === 0) {
						alert("No stations selected.");
						return;
					}

					const selectedStations = allStations.filter(
						(station: any) => selectedIds.has(station.id),
					);

					let m3uContent = "#EXTM3U\n";
					selectedStations.forEach((station: any) => {
						m3uContent += `#EXTINF:-1,${station.name}\n${station.streamUrl}\n`;
					});

					downloadFile(
						m3uContent,
						"selected_stations.m3u8",
						"text/plain;charset=utf-8",
					);
				});
			}

			const exportPlsBtn = document.getElementById("export-pls-btn");
			if (exportPlsBtn) {
				exportPlsBtn.addEventListener("click", () => {
					if (selectedIds.size === 0) {
						alert("No stations selected.");
						return;
					}

					const selectedStations = allStations.filter(
						(station: any) => selectedIds.has(station.id),
					);

					let plsContent = "[playlist]\n";
					plsContent += `NumberOfEntries=${selectedStations.length}\n`;

					selectedStations.forEach((station: any, index: number) => {
						const i = index + 1;
						plsContent += `File${i}=${station.streamUrl}\n`;
						plsContent += `Title${i}=${station.name}\n`;
						plsContent += `Length${i}=-1\n`;
					});

					plsContent += "Version=2\n";

					downloadFile(
						plsContent,
						"selected_stations.pls",
						"text/plain",
					);
				});
			}

			function downloadFile(
				content: string,
				filename: string,
				type: string,
			) {
				const blob = new Blob([content], { type: type });
				const url = URL.createObjectURL(blob);
				const a = document.createElement("a");
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			}

			// Favicon handling
			const stationImages = document.querySelectorAll(
				"img[data-favicon]",
			) as NodeListOf<HTMLImageElement>;

			stationImages.forEach((img) => {
				const faviconUrl = img.dataset.favicon;
				if (faviconUrl) {
					const tempImg = new Image();
					tempImg.onload = () => {
						img.src = faviconUrl;
					};
					// Handle error silently, placeholder remains
					tempImg.onerror = () => {};
					tempImg.src = faviconUrl;
				}
			});

			// Search and Filter functionality
			const searchInput = document.getElementById(
				"search-input",
			) as HTMLInputElement;
			const countryFilter = document.getElementById(
				"country-filter",
			) as HTMLSelectElement;
			const codecFilter = document.getElementById(
				"codec-filter",
			) as HTMLSelectElement;
			const bitrateFilter = document.getElementById(
				"bitrate-filter",
			) as HTMLInputElement;
			const stationItems = document.querySelectorAll(
				"li[data-name]",
			) as NodeListOf<HTMLLIElement>;

			function filterStations() {
				const query = searchInput
					? searchInput.value.trim().toLowerCase()
					: "";
				const selectedCountry = countryFilter
					? countryFilter.value
					: "";
				const selectedCodec = codecFilter ? codecFilter.value : "";
				const minBitrate =
					bitrateFilter && bitrateFilter.value
						? parseInt(bitrateFilter.value)
						: 0;

				stationItems.forEach((item) => {
					const name = item.dataset.name || "";
					const country = item.dataset.country || "";
					const codec = item.dataset.codec || "";
					const bitrate = item.dataset.bitrate
						? parseInt(item.dataset.bitrate)
						: 0;

					const matchesName = name.includes(query);
					const matchesCountry =
						selectedCountry === "" || country === selectedCountry;
					const matchesCodec =
						selectedCodec === "" || codec === selectedCodec;
					const matchesBitrate = bitrate >= minBitrate;

					item.style.display =
						matchesName &&
						matchesCountry &&
						matchesCodec &&
						matchesBitrate
							? ""
							: "none";
				});
			}

			if (searchInput) {
				searchInput.addEventListener("input", filterStations);
			}

			if (countryFilter) {
				countryFilter.addEventListener("change", filterStations);
			}

			if (codecFilter) {
				codecFilter.addEventListener("change", filterStations);
			}

			if (bitrateFilter) {
				bitrateFilter.addEventListener("input", filterStations);
			}

			const clearFiltersBtn =
				document.getElementById("clear-filters-btn");
			if (clearFiltersBtn) {
				clearFiltersBtn.addEventListener("click", () => {
					if (searchInput) searchInput.value = "";
					if (countryFilter) countryFilter.value = "";
					if (codecFilter) codecFilter.value = "";
					if (bitrateFilter) bitrateFilter.value = "";
					filterStations();
				});
			}
		});
	</script>
</BaseLayout>
